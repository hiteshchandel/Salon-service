<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staff Availability</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; color:#333; }
    .navbar { display:flex; justify-content:space-between; align-items:center; background:#333; padding:12px 20px; }
    .navbar a { color:white; margin:0 12px; text-decoration:none; font-weight:bold; padding:6px 12px; border-radius:20px; transition: background 0.3s,color 0.3s; }
    .navbar a.active { background:white; color:#333; }
    .navbar button { background:#e74c3c; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; }
    .container { max-width:1000px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    h2 { margin-bottom:15px; color:#444; text-align:center; }
    form { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; align-items:center; justify-content:center; }
    select,input { padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
    .add-btn { background:#3498db; color:white; }
    .save-btn { background:#27ae60; color:white; }
    .delete-btn { background:#e74c3c; color:white; }
    .search-bar { margin-bottom:20px; text-align:center; }
    .search-bar input { padding:8px; width:250px; border-radius:6px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { border:1px solid #ddd; padding:12px; text-align:center; }
    th { background:#f1f1f1; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-links" id="navLinks"></div>
    <button onclick="logout()">Logout</button>
  </nav>

  <div class="container">
    <h2>Manage Availability</h2>

    <div class="search-bar" id="searchContainer" style="display:none;">
      <input type="text" id="searchInput" placeholder="Search staff by name..." onkeyup="filterByName()">
    </div>

    <form id="availabilityForm" style="display:none;">
      <input type="hidden" id="editId">
      <label>
        Day of Week:
        <select id="dayOfWeek">
          <option value="">-- Select --</option>
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>
      </label>
      <label>
        Start:
        <input type="time" id="startTime" required>
      </label>
      <label>
        End:
        <input type="time" id="endTime" required>
      </label>
      <button type="submit" id="formBtn" class="add-btn">Add Availability</button>
    </form>

    <table id="availabilityTable">
      <thead>
        <tr>
          <th>Staff</th>
          <th>Day</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Status / Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const token = sessionStorage.getItem("token");
    const role = sessionStorage.getItem("role"); // "admin" or "staff"
    if (!token) window.location.href="/";

    const navLinksContainer = document.getElementById("navLinks");
    const links = {
      admin: [
        { name:"Services", href:"/dashboard" },
        { name:"Admin Dashboard", href:"/admin" },
        { name:"Manage Staff", href:"/staff" },
        { name:"Staff Availability", href:"/availability" },
        { name:"Profile", href:"/profile" }
      ],
      staff: [
        { name:"Services", href:"/dashboard" },
        { name:"My Appointments", href:"/appointments" },
        { name:"Staff Availability", href:"/availability" },
        { name:"Profile", href:"/profile" }
      ]
    };
    (links[role]||[]).forEach(l=>{
      const a=document.createElement("a");
      a.href=l.href; a.innerText=l.name;
      if(l.href===window.location.pathname) a.classList.add("active");
      navLinksContainer.appendChild(a);
    });

    const tableBody = document.querySelector("#availabilityTable tbody");
    const daySelect = document.getElementById("dayOfWeek");
    const form = document.getElementById("availabilityForm");
    const formBtn = document.getElementById("formBtn");
    const editIdField = document.getElementById("editId");
    const searchContainer = document.getElementById("searchContainer");
    const dayMap = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    let allItems = [];

    document.addEventListener("DOMContentLoaded", () => {
      if(role !== "admin" && role !== "staff") { alert("Access Denied."); window.location.href="/dashboard"; return; }
      if(role==="admin") searchContainer.style.display="block";
      if(role==="staff") form.style.display="flex";
      loadAvailability();
    });

    async function loadAvailability() {
      try {
        const res = await fetch("/api/availability", { headers:{Authorization:`Bearer ${token}`} });
        const data = await res.json();
        allItems = data.availability || [];
        renderTable(allItems);
        if(role==="staff") disableUsedDays(allItems);
      } catch(e){ console.error(e); }
    }

    function renderTable(items) {
      tableBody.innerHTML="";
      items.forEach(av=>{
        const tr=document.createElement("tr");
        if(role==="staff"){
          tr.innerHTML=`
            <td>${av.User?.name||"-"}</td>
            <td>${dayMap[av.dayOfWeek]}</td>
            <td>${av.startTime}</td>
            <td>${av.endTime}</td>
            <td>
              <button class="save-btn" onclick="editAvailability(${av.id}, ${av.dayOfWeek}, '${av.startTime}','${av.endTime}')">Edit</button>
              <button class="delete-btn" onclick="deleteAvailability(${av.id})">Delete</button>
            </td>
          `;
        } else {
          tr.innerHTML=`
            <td>${av.User?.name||"-"}</td>
            <td>${dayMap[av.dayOfWeek]}</td>
            <td>${av.startTime}</td>
            <td>${av.endTime}</td>
            <td>${av.isActive?"Active":"Inactive"}</td>
          `;
        }
        tableBody.appendChild(tr);
      });
    }

    function filterByName(){
      const term=document.getElementById("searchInput").value.toLowerCase();
      renderTable(allItems.filter(av=> (av.User?.name||"").toLowerCase().includes(term)));
    }

    function disableUsedDays(items){
      [...daySelect.options].forEach(opt=>opt.disabled=false);
      const used = items.map(av=>av.dayOfWeek.toString());
      [...daySelect.options].forEach(opt=>{ if(used.includes(opt.value)) opt.disabled=true; });
    }

    form.addEventListener("submit", async e=>{
      e.preventDefault();
      const payload = {
        dayOfWeek: parseInt(daySelect.value),
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value
      };
      const editId = editIdField.value;
      let res;
      if(editId){
        res = await fetch(`/api/availability/${editId}`, { method:"PUT", headers:{"Content-Type":"application/json", Authorization:`Bearer ${token}`}, body:JSON.stringify(payload)});
      } else {
        res = await fetch("/api/availability/", { method:"POST", headers:{"Content-Type":"application/json", Authorization:`Bearer ${token}`}, body:JSON.stringify(payload)});
      }
      const data = await res.json();
      alert(data.message);
      form.reset();
      editIdField.value="";
      formBtn.textContent="Add Availability"; formBtn.className="add-btn";
      loadAvailability();
    });

    function editAvailability(id, day, start, end){
      editIdField.value=id;
      daySelect.value=day;
      document.getElementById("startTime").value=start.slice(0,5);
      document.getElementById("endTime").value=end.slice(0,5);
      formBtn.textContent="Save Changes"; formBtn.className="save-btn";
    }

    async function deleteAvailability(id){
      if(!confirm("Delete this availability?")) return;
      const res = await fetch(`/api/availability/${id}`, { method:"DELETE", headers:{Authorization:`Bearer ${token}`}});
      const data = await res.json();
      alert(data.message);
      loadAvailability();
    }

    function logout(){ sessionStorage.clear(); window.location.href="/"; }
  </script>
</body>
</html>

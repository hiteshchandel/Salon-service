<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Service</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; color:#333; }
    .navbar { display:flex; justify-content:space-between; align-items:center; background:#333; padding:12px 20px; }
    .navbar a { color:white; margin:0 12px; text-decoration:none; font-weight:bold; padding:6px 12px; border-radius:20px; transition:background 0.3s,color 0.3s; }
    .navbar a.active { background:white; color:#333; }
    .navbar button { background:#e74c3c; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; }
    .container { max-width:800px; margin:20px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    h1,h2 { text-align:center; margin-bottom:15px; }
    .staff-list, .days, .slots { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:15px 0; }
    .staff-btn,.day-btn,.slot-btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; background:#3498db; color:white; }
    .staff-btn.active, .day-btn.active, .slot-btn.active { background:#27ae60; }
    #bookBtn { display:block; margin:20px auto; padding:10px 20px; font-size:16px; border:none; border-radius:6px; background:#27ae60; color:white; cursor:pointer; }
    #bookBtn:disabled { background:#aaa; cursor:not-allowed; }
  </style>
</head>
<body>
  <!-- ✅ Navbar -->
  <nav class="navbar">
    <div class="nav-links">
      <a href="/dashboard">Services</a>
      <a href="/appointments">My Appointments</a>
      <a href="/users">Manage Users</a>
      <a href="/staff">Manage Staff</a>
      <a href="/availability">Staff availability</a>
      <a href="/profile">Profile</a>
    </div>
    <button onclick="logout()">Logout</button>
  </nav>

  <div class="container">
    <h1 id="serviceName">Loading...</h1>
    <p id="serviceDesc"></p>
    <p><strong>Duration:</strong> <span id="serviceDuration"></span> min</p>
    <p><strong>Price:</strong> ₹<span id="servicePrice"></span></p>

    <h2>Select Staff</h2>
    <div class="staff-list" id="staffList"></div>

    <h2>Select Day</h2>
    <div class="days" id="days"></div>

    <h2>Select Time Slot</h2>
    <div class="slots" id="slots"></div>

    <button id="bookBtn" disabled>Book Appointment</button>
  </div>

  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    const token = sessionStorage.getItem("token");
    const serviceId = sessionStorage.getItem("selectedServiceId"); 
    if (!token || !serviceId) {
      alert("Invalid session, please login again.");
      window.location.href = "login.html";
    }

    let selectedStaff = null;
    let selectedDay = null;
    let selectedSlot = null;
    let serviceData = null;

    async function init() {
      await fetchService();
      await fetchStaff();
    }

    // ✅ Fetch service detail
    async function fetchService() {
      const res = await fetch(`/api/services/`, { headers: { Authorization: `Bearer ${token}` }});
      const data = await res.json();
      serviceData = data.services.find(s => s.id == serviceId);
      if (!serviceData) { alert("Service not found"); return; }
      document.getElementById("serviceName").textContent = serviceData.name;
      document.getElementById("serviceDesc").textContent = serviceData.description || "";
      document.getElementById("serviceDuration").textContent = serviceData.duration;
      document.getElementById("servicePrice").textContent = serviceData.price;
    }

    async function fetchStaff() {
      try {
        const res = await fetch(`/api/staff/staffByService?serviceId=${serviceId}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const staff = await res.json();
        
        const container = document.getElementById("staffList");
        container.innerHTML = "";
        staff.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "staff-btn";
          btn.textContent = s.name;
          btn.onclick = () => selectStaff(s);
          container.appendChild(btn);
        });
      } catch (err) {
        console.error("❌ Error fetching staff:", err);
      }
    }


    function selectStaff(s) {
      selectedStaff = s;
      document.querySelectorAll(".staff-btn").forEach(b => b.classList.remove("active"));
      event.target.classList.add("active");
      fetchDays(s.id);
    }

    // ✅ Fetch available days for staff
    async function fetchDays(staffId) {
      const res = await fetch(`/api/availability?staffId=${staffId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const container = document.getElementById("days");
      container.innerHTML = "";
      (data.availability || []).forEach(av => {
        const btn = document.createElement("button");
        btn.className = "day-btn";
        btn.textContent = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][av.dayOfWeek];
        btn.onclick = () => selectDay(av.dayOfWeek);
        container.appendChild(btn);
      });
    }

    function selectDay(day) {
      selectedDay = day;

      document.querySelectorAll(".day-btn").forEach(b => b.classList.remove("active"));
      event.target.classList.add("active");

      // Send full date instead of only dayOfWeek
      const today = new Date();
      const date = new Date(today.setDate(today.getDate() + ((day + 7 - today.getDay()) % 7)));
      const formattedDate = date.toISOString().split("T")[0]; // "2025-09-27"

      fetchSlots(selectedStaff.id, formattedDate, day);
    }


// ✅ Fetch available slots for selected staff & date
async function fetchSlots(staffId, date) {
  try {
    const res = await fetch(`/api/availability/${staffId}/slots?date=${date}&serviceId=${serviceId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) throw new Error("Failed to fetch slots");
    const data = await res.json();

    const container = document.getElementById("slots");
    container.innerHTML = "";

    if (!data.slots || data.slots.length === 0) {
      container.innerHTML = "<p>No available slots</p>";
      document.getElementById("bookBtn").disabled = true;
      return;
    }

    (data.slots || []).forEach(slot => {
      const btn = document.createElement("button");
      btn.className = "slot-btn";
      btn.textContent = slot.display; // "HH:MM - HH:MM"

      if (slot.booked) {
        btn.disabled = true;
        btn.style.background = "#e74c3c";
        btn.title = slot.bookedBy ? `Booked by ${slot.bookedBy}` : "Booked";
      } else {
        btn.onclick = () => selectSlot(slot);
      }

      container.appendChild(btn);
    });


  } catch (err) {
    console.error("❌ Error fetching slots:", err);
    alert("Failed to load slots. Try again later.");
  }
}

// ✅ Select slot
function selectSlot(slot) {
  selectedSlot = slot; // store full slot object
  document.querySelectorAll(".slot-btn").forEach(b => b.classList.remove("active"));
  event.target.classList.add("active");
  document.getElementById("bookBtn").disabled = false;
}



    // ✅ Book appointment
    document.getElementById("bookBtn").addEventListener("click", async () => {
      if (!selectedStaff || !selectedDay || !selectedSlot) return alert("Select all options");

      // Step 1: Create Razorpay order + draft appointment
      const res = await fetch("/api/appointments/create-order", {
        method:"POST",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({
          serviceId,
          staffId: selectedStaff.id,
          date: selectedDay,            
          startTime: selectedSlot.startTime,   // ✅ correct
          endTime: selectedSlot.endTime,       // ✅ correct
          price: serviceData.price
        })
      });
      const data = await res.json();

      if (!res.ok) return alert(data.message || "Failed to create order");

      const { order, appointment, paymentId } = data;

      // Step 2: Open Razorpay Checkout
      const options = {
        key: "rzp_test_RJwYDD8h6OWBGS", // your Razorpay key
        amount: order.amount,
        currency: "INR",
        order_id: order.id,
        name: "Salon Booking",
        description: serviceData.name,
        handler: async function (response) {
          // Step 3: Verify payment
          const verifyRes = await fetch("/api/appointments/verify-payment", {
            method: "POST",
            headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}` },
            body: JSON.stringify({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
              appointmentId: appointment.id,
              paymentId: paymentId
            })
          });
          const result = await verifyRes.json();

          if (verifyRes.ok) {
            alert("Payment successful, booking confirmed!");
            window.location.href = "/appointments";
          } else {
            alert(result.message || "Payment verification failed");
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });


    function logout() {
      sessionStorage.clear();
      window.location.href = "/";
    }

    init();
  </script>
</body>
</html>

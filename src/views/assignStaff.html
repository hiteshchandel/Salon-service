<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Assign Service to Staff</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; color: #333; }
      .navbar { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 12px 20px; }
      .navbar a { color: white; margin: 0 12px; text-decoration: none; font-weight: bold; padding: 6px 12px; border-radius: 20px; transition: 0.3s; }
      .navbar a.active { background: white; color: #333; }
      .navbar button { background: #e74c3c; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; }
      .navbar button:hover { background: #c0392b; }

      main { padding: 20px; }
      .service-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
      .btn { background: #3498db; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
      .btn:hover { background: #2980b9; }
      .assigned { color: green; font-weight: bold; }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-links" id="navLinks"></div>
      <button onclick="logout()">Logout</button>
    </nav>

    <main>
      <h1>Assign Services to Staff</h1>
      <div id="serviceList"></div>
    </main>

    <script>
      const token = sessionStorage.getItem("token");
      const userRole = sessionStorage.getItem("role");

      if (!token) window.location.href = "/";

      // Role-based navbar
      const navLinksContainer = document.getElementById("navLinks");
      const links = {
        admin: [
          { name: "Services", href: "/dashboard" },
          { name: "Admin Dashboard", href: "/admin" },
          { name: "Manage Staff", href: "/staff" },
          { name: "Staff Availability", href: "/availability" },
          { name: "Profile", href: "/profile" }
        ],
        staff: [
          { name: "Services", href: "/dashboard" },
          { name: "My Appointments", href: "/appointments" },
          { name: "Profile", href: "/profile" }
        ]
      };
      (links[userRole] || []).forEach(link => {
        const a = document.createElement("a");
        a.href = link.href;
        a.innerText = link.name;
        if (link.href === window.location.pathname) a.classList.add("active");
        navLinksContainer.appendChild(a);
      });

      // Logout
      function logout() {
        sessionStorage.clear();
        window.location.href = "/";
      }

      // Highlight navbar
      const navLinks = document.querySelectorAll(".navbar a");
      navLinks.forEach(link => {
        link.addEventListener("click", () => {
          navLinks.forEach(l => l.classList.remove("active"));
          link.classList.add("active");
        });
      });

      // Get staffId from URL
      const urlParams = new URLSearchParams(window.location.search);
      const staffId = urlParams.get("staffId");
      if (!staffId) {
        alert("No staff selected!");
        window.location.href = "/staff";
      }

      // Fetch all services + staff assigned services
      async function fetchServices() {
        try {
          const res = await fetch("/api/services/", { headers: { Authorization: `Bearer ${token}` } });
          const servicesData = await res.json();
          const allServices = servicesData.services || [];

          const staffRes = await fetch(`/api/staff/${staffId}/services`, { headers: { Authorization: `Bearer ${token}` } });
          const staffData = await staffRes.json();
          const assignedServices = staffData.services.map(s => s.id);

          renderServices(allServices, assignedServices);
        } catch (err) {
          console.error("❌ Error fetching services:", err);
        }
      }

      function renderServices(services, assignedServices) {
        const list = document.getElementById("serviceList");
        list.innerHTML = "";

        services.forEach(service => {
          const isAssigned = assignedServices.includes(service.id);
          const card = document.createElement("div");
          card.className = "service-card";
          card.innerHTML = `
            <div><strong>${service.name}</strong> - ₹${service.price} / ${service.duration} min</div>
            <div>${isAssigned ? '<span class="assigned">Already Assigned</span>' : '<button class="btn">Assign</button>'}</div>
          `;
          if (!isAssigned) {
            card.querySelector("button").onclick = () => assignService(service.id);
          }
          list.appendChild(card);
        });
      }

      async function assignService(serviceId) {
        try {
          const res = await fetch(`/api/staff/${staffId}/services/${serviceId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({})
          });
          const data = await res.json();
          if (res.ok) {
            alert("Service assigned successfully!");
            fetchServices();
          } else alert(data.message || "Failed to assign service");
        } catch (err) { console.error("❌ Error assigning service:", err); }
      }

      fetchServices();
    </script>
  </body>
</html>
